<html>
<head>
    <title>A Simple SPA For Products</title>
    <script type="application/javascript">
        function displayAllProducts() {
            clearProductsTable();
            fetchAllProducts().then(displayProducts)
        }

        function displayProductsWithType() {
            clearProductsTable();
            const type = readProductType();
            fetchProductsWithType(type).then(displayProducts)
        }

        function displayProduct(name) {
            fetchProductWithName(name).then(t =>
                productDisplay().innerHTML
                    = `${t.type} type product ${t.name} with quantity "${t.quantity}"`
            )
        }

        function deleteProduct(name) {
            deleteProductWithName(name).then(() => {
                clearProductDisplay();
                displayAllProducts();
            })
        }

        function deleteProductWithName(name) {
            return sendDELETE(`/pantry/products/${name}`)
        }

        function addNewProduct() {
            const product = buildProductFromForm();
            sendPOST("/pantry/products", product).then(displayAllProducts);
        }

        function buildProductFromForm() {
            return {
                name: getProductFormValue("newProductName"),
                quantity: getProductFormValue("newProductQuantity"),
                type: getProductFormValue("newProductType")
            }
        }

        function getProductFormValue(controlName) {
            return document.addProductForm[controlName].value;
        }

        function productDisplay() {
            return document.getElementById("currentProductDisplay");
        }

        function readProductType() {
            return document.typeForm.type.value
        }

        function fetchProductsWithType(type) {
            return sendGET(`/pantry/products/byType/${type}`);
        }

        function fetchProductWithName(name) {
            return sendGET(`/pantry/products/byName/${name}`);
        }

        function fetchAllProducts() {
            return sendGET("/pantry/products")
        }

        function sendGET(url) {
            return fetch(
                url,
                {headers: {'Accept': 'application/json'}}
            ).then(response => {
                if (response.ok) {
                    return response.json()
                }
                return [];
            });
        }

        function sendPOST(url, data) {
            return fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
        }

        function sendDELETE(url) {
            return fetch(url, {
                method: "DELETE"
            });
        }

        function productsTable() {
            return document.getElementById("productsTableBody");
        }

        function clearProductsTable() {
            productsTable().innerHTML = "";
        }

        function clearProductDisplay() {
            productDisplay().innerText = "None";
        }

        function displayProducts(products) {
            const productsTableBody = productsTable()
            products.forEach(product => {
                const newRow = productRow(product);
                productsTableBody.appendChild(newRow);
            });
        }

        function productRow(product) {
            return tr([
                td(product.name),
                td(product.type),
                td(viewLink(product.name)),
                td(deleteLink(product.name)),
            ]);
        }

        function tr(children) {
            const node = document.createElement("tr");
            children.forEach(child => node.appendChild(child));
            return node;
        }

        function td(content) {
            const node = document.createElement("td");
            if (content instanceof Element) {
                node.appendChild(content)
            } else {
                node.appendChild(document.createTextNode(content));
            }
            return node;
        }

        function viewLink(productName) {
            const node = document.createElement("a");
            node.setAttribute(
                "href", `javascript:displayProduct("${productName}")`
            )
            node.appendChild(document.createTextNode("view"));
            return node;
        }

        function deleteLink(productName) {
            const node = document.createElement("a");
            node.setAttribute(
                "href", `javascript:deleteProduct("${productName}")`
            )
            node.appendChild(document.createTextNode("delete"));
            return node;
        }
    </script>
</head>
<body onload="displayAllProducts()">
<h1>Product Manager Client</h1>
<form action="javascript:displayAllProducts()">
    <span>View all the products</span>
    <input type="submit" value="Go">
</form>
<form name="typeForm" action="javascript:displayProductsWithType()">
    <span>View products with type</span>
    <select name="type">
        <option name="Vegetable">Vegetable</option>
        <option name="Meat">Meat</option>
        <option name="Fruit">Fruit</option>
        <option name="Dairy">Dairy</option>
        <option name="Other">Other</option>
    </select>
    <input type="submit" value="Go">
</form>
<form name="addProductForm" action="javascript:addNewProduct()">
    <span>Create new product with</span>
    <label for="newProductName">name</label>
    <input type="text" id="newProductName" name="newProductName" size="10">
    <label for="newProductQuantity">quantity</label>
    <input type="number" id="newProductQuantity" name="newProductQuantity" size="20">
    <label for="newProductType">type</label>
    <select id="newProductType" name="newProductType">
        <option name="Vegetable">Vegetable</option>
        <option name="Meat">Meat</option>
        <option name="Fruit">Fruit</option>
        <option name="Dairy">Dairy</option>
        <option name="Other">Other</option>
    </select>
    <input type="submit" value="Go">
</form>
<hr>
<div>
    Current product is <em id="currentProductDisplay">None</em>
</div>
<hr>
<table>
    <thead>
    <tr>
        <th>Name</th>
        <th>Type</th>
        <th></th>
        <th></th>
    </tr>
    </thead>
    <tbody id="productsTableBody">
    </tbody>
</table>
</body>
</html>
